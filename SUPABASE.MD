# Supabase - Scrutinia Database Schema

## üìã Informaci√≥n del Proyecto

- **Project ID:** `jqfwnvtxakilaqwfyjcf`
- **URL:** `https://jqfwnvtxakilaqwfyjcf.supabase.co`
- **Schema Version:** `scrutinia_actas_v6`

---

## üìä Estructura de Tablas

### 1. `partidos` - Tabla Maestra de Partidos
| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | UUID | PK, auto-generado |
| `siglas` | TEXT | Ej: PP, PSOE, VOX (UNIQUE) |
| `nombre_completo` | TEXT | Nombre oficial completo |
| `provincias` | TEXT[] | Array de provincias donde se presenta |
| `created_at` | TIMESTAMPTZ | Fecha de creaci√≥n |

---

### 2. `mesas` - Mesas Electorales (Censo)
| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | UUID | PK, auto-generado |
| `provincia` | TEXT | Zaragoza, Huesca, Teruel |
| `municipio` | TEXT | Nombre del municipio |
| `distrito` | TEXT | C√≥digo de distrito censal |
| `seccion` | TEXT | C√≥digo de secci√≥n |
| `mesa` | TEXT | Letra de mesa (A, B, U, A-K...) |
| `codigo_unico` | TEXT | Generado: `ZAR-ZARAGOZA-05-043-A` |
| `id_colegio_csv` | TEXT | ID del CSV original |
| `nombre_colegio` | TEXT | Nombre del colegio electoral |
| `direccion` | TEXT | Direcci√≥n f√≠sica |
| `apellido_desde` | TEXT | Rango de apellidos (desde) |
| `apellido_hasta` | TEXT | Rango de apellidos (hasta) |
| `censo_oficial` | INT | N√∫mero de electores censados |
| `created_at` | TIMESTAMPTZ | Fecha de creaci√≥n |

**√çndice √∫nico:** `(provincia, municipio, distrito, seccion, mesa)`

---

### 3. `actas` - Actas Electorales (JSON v6)

#### Metadata
| Campo | Tipo | JSON Path | Descripci√≥n |
|-------|------|-----------|-------------|
| `id` | UUID | - | PK, auto-generado |
| `mesa_id` | UUID | - | FK a `mesas` |
| `submission_id` | TEXT | `output.submission_id` | ID √∫nico de env√≠o (UNIQUE) |
| `acta_key` | TEXT | `output.acta_key` | `PROVINCIA\|MUNICIPIO\|DISTRITO\|SECCION\|MESA` |
| `source_file_id` | TEXT | `output.source_file_id` | ID archivo Google Drive |
| `imagen_url` | TEXT | - | URL en Supabase Storage |
| `imagen_renamed` | TEXT | `output.drive.renamed_file` | Nombre de archivo renombrado |
| `extracted_text_raw` | TEXT | `output.extracted_text_raw` | OCR completo de la IA |
| `human_message` | TEXT | `output.human_message` | Mensaje para revisi√≥n humana |

#### Datetime
| Campo | Tipo | JSON Path | Descripci√≥n |
|-------|------|-----------|-------------|
| `fecha_acta` | DATE | `structured_data.datetime.*` | Fecha completa del acta |
| `hora_acta` | TIME | `structured_data.datetime.hora` | Hora de cierre |

#### Censo
| Campo | Tipo | JSON Path | Descripci√≥n |
|-------|------|-----------|-------------|
| `censo_electores_listas` | INT | `structured_data.censo.electores_listas` | Electores seg√∫n listas |
| `censo_certificaciones_presentadas` | INT | `structured_data.censo.certificaciones_presentadas` | Certificaciones presentadas |
| `certificaciones_alta` | INT | `structured_data.censo.certificaciones_alta` | Altas por certificaci√≥n |
| `certificaciones_error` | INT | `structured_data.censo.certificaciones_correccion` | Correcciones |
| `censo_total_electores` | INT | `structured_data.censo.total_electores` | Total electores |

#### Votantes
| Campo | Tipo | JSON Path | Descripci√≥n |
|-------|------|-----------|-------------|
| `votantes_censados_votaron` | INT | `structured_data.votantes.censados_votaron` | Electores que votaron |
| `votantes_interventores` | INT | `structured_data.votantes.interventores_no_censados` | Interventores |
| `total_votantes` | INT | `structured_data.votantes.total_votantes` | Total votantes |

#### Incidencias
| Campo | Tipo | JSON Path | Descripci√≥n |
|-------|------|-----------|-------------|
| `votos_nulos` | INT | `structured_data.incidencias.votos_nulos` | Votos nulos |
| `votos_blanco` | INT | `structured_data.incidencias.votos_blanco` | Votos en blanco |
| `votos_candidaturas` | INT | - | Suma calculada de votos a partidos |

#### Votos por Partido
| Campo | Tipo | JSON Path | Descripci√≥n |
|-------|------|-----------|-------------|
| `votes_by_party_id` | JSONB | `structured_data.votes_by_party_id` | `{"PP": 142, "PSOE": 133, ...}` |

#### Firmas
| Campo | Tipo | JSON Path | Descripci√≥n |
|-------|------|-----------|-------------|
| `firma_presidente` | TEXT | `structured_data.firmas.presidente` | Nombre del presidente |
| `firma_vocal_1` | TEXT | `structured_data.firmas.vocal_1` | Nombre vocal 1 |
| `firma_vocal_2` | TEXT | `structured_data.firmas.vocal_2` | Nombre vocal 2 |
| `firma_representantes` | TEXT[] | `structured_data.firmas.representantes` | Array de representantes |

#### Issues y Estado
| Campo | Tipo | JSON Path | Descripci√≥n |
|-------|------|-----------|-------------|
| `issues` | TEXT[] | `structured_data.issues` | Array de incidencias IA |
| `observaciones` | TEXT | - | Notas adicionales |
| `estado` | TEXT | - | `pendiente`, `verificada`, `incidencia` |
| `incidencia_tipo` | TEXT | - | Descripci√≥n del error |

---

### 4. `detalle_votos` - Desglose por Partido

| Campo | Tipo | JSON Path | Descripci√≥n |
|-------|------|-----------|-------------|
| `id` | UUID | - | PK |
| `acta_id` | UUID | - | FK a `actas` |
| `orden` | INT | `candidaturas_raw[].orden` | Posici√≥n en papeleta |
| `party_name_raw` | TEXT | `candidaturas_raw[].party_name_raw` | Nombre completo con siglas |
| `partido_siglas` | TEXT | - | Siglas normalizadas (PP, PSOE...) |
| `partido_nombre` | TEXT | - | Nombre limpio |
| `votos_letra` | TEXT | `candidaturas_raw[].votos_letra` | "CIENTO CUARENTA Y DOS" |
| `votos` | INT | `candidaturas_raw[].votos_numero` | 142 |

---

### 5. `candidaturas_unmapped` - Partidos No Mapeados

| Campo | Tipo | JSON Path | Descripci√≥n |
|-------|------|-----------|-------------|
| `id` | UUID | - | PK |
| `acta_id` | UUID | - | FK a `actas` |
| `party_name_raw` | TEXT | `candidaturas_unmapped[].party_name_raw` | Nombre original |
| `votos_letra` | TEXT | `candidaturas_unmapped[].votos_letra` | Votos en texto |
| `votos_numero` | INT | `candidaturas_unmapped[].votos_numero` | Votos en n√∫mero |
| `reason` | TEXT | `candidaturas_unmapped[].reason` | Raz√≥n del fallo |

---

### 6. `resultados_publicos` - Agregados para Dashboard

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | UUID | PK |
| `provincia` | TEXT | Zaragoza, Huesca, Teruel |
| `candidatura` | TEXT | Siglas del partido |
| `votos_totales` | INT | Suma de votos |
| `porcentaje` | NUMERIC(5,2) | % sobre votos v√°lidos |
| `esca√±os` | INT | Esca√±os asignados (D'Hondt) |
| `updated_at` | TIMESTAMPTZ | √öltima actualizaci√≥n |

---

## üîÑ Mapeo JSON ‚Üí Base de Datos

```
output.submission_id          ‚Üí actas.submission_id
output.acta_key               ‚Üí actas.acta_key
output.source_file_id         ‚Üí actas.source_file_id
output.drive.renamed_file     ‚Üí actas.imagen_renamed
output.extracted_text_raw     ‚Üí actas.extracted_text_raw
output.human_message          ‚Üí actas.human_message

structured_data.scope.*       ‚Üí Buscar/crear en tabla `mesas`
structured_data.datetime.*    ‚Üí actas.fecha_acta, actas.hora_acta
structured_data.censo.*       ‚Üí actas.censo_*
structured_data.votantes.*    ‚Üí actas.votantes_*, actas.total_votantes
structured_data.incidencias.* ‚Üí actas.votos_nulos, actas.votos_blanco
structured_data.votes_by_party_id ‚Üí actas.votes_by_party_id (JSONB)
structured_data.candidaturas_raw[] ‚Üí tabla `detalle_votos`
structured_data.candidaturas_unmapped[] ‚Üí tabla `candidaturas_unmapped`
structured_data.firmas.*      ‚Üí actas.firma_*
structured_data.issues[]      ‚Üí actas.issues
```

---

## üìù Migraciones Aplicadas

### `adapt_schema_to_scrutinia_json_v6` (2026-02-01)
- A√±adidos campos de metadata a `actas`
- A√±adidos campos de censo y votantes expandidos
- A√±adido campo `votes_by_party_id` JSONB
- A√±adidos campos de firmas
- A√±adido array `issues`
- Creada tabla `candidaturas_unmapped`
- A√±adidos √≠ndices de b√∫squeda
- Constraint UNIQUE en `submission_id`

---

## üîê Pol√≠ticas RLS (Row Level Security)

**Estado actual:** RLS deshabilitado en todas las tablas.

**Recomendaci√≥n para producci√≥n:**
```sql
-- Habilitar RLS
ALTER TABLE public.actas ENABLE ROW LEVEL SECURITY;

-- Pol√≠tica de lectura p√∫blica
CREATE POLICY "Lectura p√∫blica de actas verificadas"
ON public.actas FOR SELECT
USING (estado = 'verificada');

-- Pol√≠tica de inserci√≥n para usuarios autenticados
CREATE POLICY "Inserci√≥n para autenticados"
ON public.actas FOR INSERT
WITH CHECK (auth.uid() IS NOT NULL);
```

---

## üîó Realtime

**Tablas con Realtime habilitado:**
- `resultados_publicos` - Para actualizaci√≥n en vivo del dashboard
- `actas` - Para notificaciones de nuevas actas

**Configurar en:** Dashboard ‚Üí Database ‚Üí Replication
